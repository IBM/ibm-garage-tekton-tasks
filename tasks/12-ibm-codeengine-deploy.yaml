apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: ibm-codeengine-deploy
spec:
  params:
    - name: image-to
      type: string
    - name: tools-image
      default: garagecatalyst/ibmcloud-dev:1.1.3
    - name: source-dir
      default: /source
  volumes:
    - name: source
      emptyDir: {}
  stepTemplate:
    volumeMounts:
      - name: source
        mountPath: $(params.source-dir)
  steps:
    - name: codeengine-deploy
      image: $(params.tools-image)
      workingdir: $(params.source-dir)
      env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: APIKEY
          valueFrom:
            secretKeyRef:
              name: ibmcloud-apikey
              key: APIKEY
              optional: true
        - name: CE_DEPLOY
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_DEPLOY
              optional: false 
        - name: CE_PROJECT_NAME
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_PROJECT_NAME
              optional: true 
        - name: CE_APP_NAME
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_APP_NAME
              optional: true 
        - name: CE_IMAGE_ACCESS
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_IMAGE_ACCESS
              optional: true 
        - name: CE_REGION
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_REGION
              optional: true 
        - name: CE_RESOURCE_GROUP
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_RESOURCE_GROUP
              optional: true 
        - name: CE_CPU
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_CPU
              optional: true 
        - name: CE_MEMORY
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_MEMORY
              optional: true 
        - name: CE_MIN_SCALE
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_MIN_SCALE
              optional: true 
        - name: CE_MAX_SCALE
          valueFrom:
            secretKeyRef:
              name: codeengine-access
              key: CE_MAX_SCALE
              optional: true 
      resources: {}         
      script: |
        #!/usr/bin/env bash
        set -ex
        echo "Code Engine Deploy Process getting Started"
        ibmcloud plugin install code-engine
        

        echo "assiging parameter"
        
        # CE_DEPLOY="N"  -- Code Engine Deploy Flag (true or false)
        # CE_PROJECT_NAME="CE-POC"
        # CE_APP_NAME="java-spring"
        # CE_IMAGE_REPO="us.icr.io/appdev-ocp45-vpc/code-engine-demo-pvt" or "us.icr.io/appdev-ocp45-vpc/javaspring:0.0.1" -- not required
        # CE_IMAGE_ACCESS="ibm-registry-us"
        # CE_REGION="us-south"
        # CE_RESOURCE_GROUP="cloud-native-development" or "appdev-cloud-native"
        # CE_CPU="0.5"
        # CE_MEMORY="1G"
        # CE_MIN_SCALE="0"
        # CE_MAX_SCALE="10"

        if [[ ! "${CE_DEPLOY}" =~ true ]]; then
          echo "Code Engine Deployment is not Enabled"
          exit 0
        fi
        
        CE_IMAGE_REPO="$(params.image-to)"
        echo "IMG Tag "${CE_IMAGE_REPO}

        set -o
        ibmcloud login --apikey ${APIKEY} -r ${CE_REGION} -g ${CE_RESOURCE_GROUP}
        set +o

        ibmcloud ce project select -n ${CE_PROJECT_NAME}

        set +e
        APP_EXIST=$(ibmcloud ce app get --name ${CE_APP_NAME})
        echo "APP EXIST "${APP_EXIST}
        set -e 
        

        if [[ "${APP_EXIST}" == "null" ]] || [[ -z  "${APP_EXIST}" ]]; then 
          echo "Application doesn't exists"
          # ibmcloud ce app create --name ce-springbt-pvt-app --image us.icr.io/appdev-ocp45-vpc/code-engine-demo-pvt --registry-secret ibm-registry-us
          ibmcloud ce app create --name ${CE_APP_NAME} --image ${CE_IMAGE_REPO}  --registry-secret ${CE_IMAGE_ACCESS} --cpu ${CE_CPU} --memory ${CE_MEMORY} --min ${CE_MIN_SCALE} --max ${CE_MAX_SCALE}
        else
          echo "Application name already exists"
          # ibmcloud ce app update --name ce-springbt-pvt-app --image us.icr.io/appdev-ocp45-vpc/code-engine-demo-pvt --registry-secret ibm-registry-us
          ibmcloud ce app update --name ${CE_APP_NAME} --image ${CE_IMAGE_REPO}  --registry-secret ${CE_IMAGE_ACCESS} --cpu ${CE_CPU} --memory ${CE_MEMORY} --min ${CE_MIN_SCALE} --max ${CE_MAX_SCALE}
        fi

        
        echo "Code Engine Deploy Process completed"
        
      